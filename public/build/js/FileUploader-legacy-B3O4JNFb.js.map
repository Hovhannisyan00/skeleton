{"version":3,"file":"FileUploader-legacy-B3O4JNFb.js","sources":["../../../resources/js/core/FileUploader.js"],"sourcesContent":["import Modal from '../core/Modal.js';\n// eslint-disable-next-line no-underscore-dangle,no-unused-vars\n\n// const cropperModal = new Modal('cropImageModal');\nconst cropperModal = new Modal('cropImageModal');\n\nclass FileUploader {\n  constructor() {\n    this.init();\n  }\n\n  init() {\n    this.deleteFileEvent();\n    this.$_functions();\n  }\n\n  $_functions() {\n    $('body').on('click', '.__delete__file__btn', this.deleteFileHandler.bind(this));\n    $('input[type=file].temp-file-type').change(this.fileChangeHandle.bind(this));\n  }\n\n  getAttribute(qualifiedDataName) {\n    return this.$el.getAttribute(`data-${qualifiedDataName}`);\n  }\n\n  fileChangeHandle() {\n    this.$el = event.target;\n    this.$fileListEl = $(this.$el).siblings('div.__file__list__default');\n    this.$fileErrorBox = $(this.$el).siblings('div.error-messages-block');\n    this.$fileHiddenInputsBox = $(this.$el).siblings('.hidden-file-inputs');\n    this.resetUploader();\n    this.fileData = this.$el.files;\n    this.filename = '';\n\n    if ($(this.$el).data('has-crop')) {\n      if (typeof this.cropContainer == 'undefined') {\n        this.initCroppie();\n        this.cropModalActions();\n      }\n\n      this.cropperImageChange();\n    } else {\n      this.removeOldUploadedFiles();\n      this.generateFormDataForFiles();\n    }\n\n    this.$el.value = '';\n  }\n\n  removeOldUploadedFiles() {\n    this.is_multiple = this.$el.getAttribute('multiple') !== null;\n\n    if (!this.is_multiple) {\n      $(this.$el).siblings('.__uploaded__files').remove();\n    }\n  }\n\n  initCroppie() {\n    this.cropContainer = $('.crop-img-container').croppie({\n      enableExif: true,\n      viewport: {\n        width: 200,\n        height: 200,\n        type: 'circle',\n      },\n      boundary: {\n        width: 300,\n        height: 300,\n      },\n    });\n  }\n\n  cropperImageChange() {\n    cropperModal.show();\n\n    const reader = new FileReader();\n    reader.onload = (e) => {\n      this.cropContainer.croppie('bind', {\n        url: e.target.result,\n      });\n    };\n    reader.readAsDataURL(this.fileData[0]);\n    this.filename = this.fileData[0].name;\n  }\n\n  cropModalActions() {\n    cropperModal.save(() => {\n      this.cropContainer.croppie('result', {\n        type: 'canvas',\n        size: 'viewport',\n      }).then((resp) => {\n        //\n        this.removeOldUploadedFiles();\n\n        const formData = new FormData();\n        formData.append('config_key', `${this.getAttribute('config-key')}.${this.getAttribute('name')}`);\n        formData.append('file', resp);\n        formData.append('name', this.filename);\n        this.sendData(formData, 0);\n        this.inputName = this.getAttribute('name');\n\n        cropperModal.hide();\n      });\n    });\n  }\n\n  resetUploader() {\n    this.$fileListEl.html('');\n    this.$fileErrorBox.find('ul').html('');\n    this.$fileErrorBox.hide();\n    this.$fileHiddenInputsBox.html('');\n  }\n\n  generateFormDataForFiles() {\n    if (this.fileData) {\n      this.inputName = this.getAttribute('name');\n      const configKey = this.getAttribute('config-key');\n      // eslint-disable-next-line no-restricted-syntax\n      for (const [key, file] of Object.entries(this.fileData)) {\n        const formData = new FormData();\n        formData.append('config_key', `${configKey}.${this.inputName}`);\n        formData.append('file', file);\n        this.sendData(formData, key);\n      }\n    }\n  }\n\n  async sendData(formData, fileIndex) {\n    // eslint-disable-next-line no-undef\n    this.createPreviewBlock(fileIndex);\n    // eslint-disable-next-line no-undef\n    await axios.post(route('dashboard.files.storeTempFile'), formData, {\n      onUploadProgress: (progressEvent) => {\n        const totalLength = progressEvent.lengthComputable ? progressEvent.total : progressEvent.target.getResponseHeader('content-length') || progressEvent.target.getResponseHeader('x-decompressed-content-length');\n        if (totalLength !== null) {\n          const progress = Math.round((progressEvent.loaded * 100) / totalLength);\n          this.progressBar(progress, fileIndex);\n        }\n      },\n    })\n      .then((resp) => {\n        resp = resp.data;\n        this.setPreviewValue(resp, fileIndex);\n        this.appendDeleteBtn(fileIndex);\n        this.createHiddenInputs(resp);\n      })\n      .catch((error) => {\n        this.errorHandler(error, fileIndex);\n        this.appendDeleteBtn(fileIndex, true);\n      });\n  }\n\n  setPreviewValue(fileInfo, fileIndex) {\n    const fileItem = $(this.$fileListEl)\n      .find(`.file__item[data-index=${fileIndex}]`);\n\n    fileItem.addClass(`file__item__type__${fileInfo.file_type}`);\n    fileItem.html(this.createHtmlForFile(fileInfo));\n  }\n\n  appendDeleteBtn(fileIndex, is_error = false) {\n    const fileItem = $(this.$fileListEl).find(`.file__item[data-index=${fileIndex}]`);\n    const view = ` <button class=\"position-absolute __delete__file __delete__file__btn\"\n                    data-index=\"${fileIndex}\"\n                    data-event-name=\"deleteFileItemEvent\"\n                    type=\"button\"><i class=\"fas fa-times\"></i></button>\n                    `;\n    fileItem.append(view);\n  }\n\n  createHiddenInputs(file) {\n    let arraySymbol = '';\n\n    if (this.is_multiple) {\n      arraySymbol = '[]';\n    }\n\n    this.$fileHiddenInputsBox.append(`<input type=\"hidden\" name=\"${this.inputName}${arraySymbol}\" value=\"${file.name}\">`);\n  }\n\n  errorHandler(error, fileIndex) {\n    const fileItem = $(this.$fileListEl).find(`.file__item[data-index=${fileIndex}]`);\n    fileItem.find('.progress-bar').addClass('bg-danger');\n\n    if (error.response && error.response.data.errors) {\n      this.$fileErrorBox.show();\n      error = error.response.data;\n      // eslint-disable-next-line no-restricted-syntax\n      for (const value of Object.entries(error.errors)) {\n        this.$fileErrorBox.find('ul').append(`<li data-index=\"${fileIndex}\">File :${fileIndex} ${value}</li>`);\n      }\n    }\n  }\n\n  progressBar(progress, fileIndex) {\n    $(this.$fileListEl)\n      .find(`.file__item[data-index=${fileIndex}] .file__progress .progress-bar`)\n      .css({ width: `${progress}%` })\n      .attr('aria-valuenow', progress)\n      .html(`${progress}%`);\n  }\n\n  createPreviewBlock(fileIndex) {\n    const preview = `\n            <div class=\"file__item d-flex justify-content-center position-relative mt-2\" data-index=\"${fileIndex}\">\n                <div class=\"progress file__progress \">\n                    <div class=\"progress-bar\"\n                         role=\"progressbar\"\n                         style=\"width: 0%;\"\n                         aria-valuenow=\"0\"\n                         aria-valuemin=\"0\"\n                         aria-valuemax=\"100\">\n                        0%\n                    </div>\n                </div>\n            </div>\n    `;\n\n    this.$fileListEl.append(preview);\n  }\n\n  // eslint-disable-next-line class-methods-use-this\n  createHtmlForFile(fileInfo) {\n    switch (fileInfo.file_type) {\n      case 'image':\n        return `<img src=\"${fileInfo.file_url}\" alt=\"${fileInfo.original_name}\" class=\"upload-file-img\">`;\n      default:\n        return `<span class=\"mr-5 text-primary p-2\">${fileInfo.original_name}</span>`;\n    }\n  }\n\n  // Delete functions start\n  deleteFileHandler(event) {\n    const el = event.target;\n    const index = $(el).data('index');\n\n    this.$fileErrorBox.find(`ul li[data-index=\"${index}\"]`).remove();\n    if (!this.$fileErrorBox.find('ul li').length) {\n      this.$fileErrorBox.hide();\n    }\n\n    $(el).closest('.file__item').remove();\n    this.$fileHiddenInputsBox.html('');\n    this.deleteFileEvent();\n  }\n\n  deleteFileEvent() {\n    window.addEventListener('deleteFileItemInDbEvent', (event) => {\n      const el = event.detail.element;\n      const boxLength = $(el).parents('.__uploaded__files').find('.file__item').length;\n      if (boxLength < 2) {\n        $(el).parents('.__uploaded__files').remove();\n      }\n      $(el).parents('.file__item').remove();\n    });\n  }\n  // Delete functions end\n}\n\n// eslint-disable-next-line no-new\nnew FileUploader();\n"],"names":["cropperModal","Modal","constructor","this","init","deleteFileEvent","$_functions","$","on","deleteFileHandler","bind","change","fileChangeHandle","getAttribute","qualifiedDataName","$el","event","target","$fileListEl","siblings","$fileErrorBox","$fileHiddenInputsBox","resetUploader","fileData","files","filename","data","cropContainer","initCroppie","cropModalActions","cropperImageChange","removeOldUploadedFiles","generateFormDataForFiles","value","is_multiple","remove","croppie","enableExif","viewport","width","height","type","boundary","show","reader","FileReader","onload","e","url","result","readAsDataURL","name","save","size","then","resp","formData","FormData","append","sendData","inputName","hide","html","find","configKey","key","file","Object","entries","fileIndex","createPreviewBlock","axios","post","route","onUploadProgress","progressEvent","totalLength","lengthComputable","total","getResponseHeader","progress","Math","round","loaded","progressBar","setPreviewValue","appendDeleteBtn","createHiddenInputs","catch","error","errorHandler","fileInfo","fileItem","addClass","file_type","createHtmlForFile","is_error","view","arraySymbol","response","errors","css","attr","preview","file_url","original_name","el","index","length","closest","window","addEventListener","detail","element","parents"],"mappings":"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"}