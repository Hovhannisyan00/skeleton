{"version":3,"file":"FileUploader-YVmStNs2.js","sources":["../../../resources/js/core/FileUploader.js"],"sourcesContent":["import Modal from '../core/Modal.js';\n// eslint-disable-next-line no-underscore-dangle,no-unused-vars\n\n// const cropperModal = new Modal('cropImageModal');\nconst cropperModal = new Modal('cropImageModal');\n\nclass FileUploader {\n  constructor() {\n    this.init();\n  }\n\n  init() {\n    this.deleteFileEvent();\n    this.$_functions();\n  }\n\n  $_functions() {\n    $('body').on('click', '.__delete__file__btn', this.deleteFileHandler.bind(this));\n    $('input[type=file].temp-file-type').change(this.fileChangeHandle.bind(this));\n  }\n\n  getAttribute(qualifiedDataName) {\n    return this.$el.getAttribute(`data-${qualifiedDataName}`);\n  }\n\n  fileChangeHandle() {\n    this.$el = event.target;\n    this.$fileListEl = $(this.$el).siblings('div.__file__list__default');\n    this.$fileErrorBox = $(this.$el).siblings('div.error-messages-block');\n    this.$fileHiddenInputsBox = $(this.$el).siblings('.hidden-file-inputs');\n    this.resetUploader();\n    this.fileData = this.$el.files;\n    this.filename = '';\n\n    if ($(this.$el).data('has-crop')) {\n      if (typeof this.cropContainer == 'undefined') {\n        this.initCroppie();\n        this.cropModalActions();\n      }\n\n      this.cropperImageChange();\n    } else {\n      this.removeOldUploadedFiles();\n      this.generateFormDataForFiles();\n    }\n\n    this.$el.value = '';\n  }\n\n  removeOldUploadedFiles() {\n    this.is_multiple = this.$el.getAttribute('multiple') !== null;\n\n    if (!this.is_multiple) {\n      $(this.$el).siblings('.__uploaded__files').remove();\n    }\n  }\n\n  initCroppie() {\n    this.cropContainer = $('.crop-img-container').croppie({\n      enableExif: true,\n      viewport: {\n        width: 200,\n        height: 200,\n        type: 'circle',\n      },\n      boundary: {\n        width: 300,\n        height: 300,\n      },\n    });\n  }\n\n  cropperImageChange() {\n    cropperModal.show();\n\n    const reader = new FileReader();\n    reader.onload = (e) => {\n      this.cropContainer.croppie('bind', {\n        url: e.target.result,\n      });\n    };\n    reader.readAsDataURL(this.fileData[0]);\n    this.filename = this.fileData[0].name;\n  }\n\n  cropModalActions() {\n    cropperModal.save(() => {\n      this.cropContainer.croppie('result', {\n        type: 'canvas',\n        size: 'viewport',\n      }).then((resp) => {\n        //\n        this.removeOldUploadedFiles();\n\n        const formData = new FormData();\n        formData.append('config_key', `${this.getAttribute('config-key')}.${this.getAttribute('name')}`);\n        formData.append('file', resp);\n        formData.append('name', this.filename);\n        this.sendData(formData, 0);\n        this.inputName = this.getAttribute('name');\n\n        cropperModal.hide();\n      });\n    });\n  }\n\n  resetUploader() {\n    this.$fileListEl.html('');\n    this.$fileErrorBox.find('ul').html('');\n    this.$fileErrorBox.hide();\n    this.$fileHiddenInputsBox.html('');\n  }\n\n  generateFormDataForFiles() {\n    if (this.fileData) {\n      this.inputName = this.getAttribute('name');\n      const configKey = this.getAttribute('config-key');\n      // eslint-disable-next-line no-restricted-syntax\n      for (const [key, file] of Object.entries(this.fileData)) {\n        const formData = new FormData();\n        formData.append('config_key', `${configKey}.${this.inputName}`);\n        formData.append('file', file);\n        this.sendData(formData, key);\n      }\n    }\n  }\n\n  async sendData(formData, fileIndex) {\n    // eslint-disable-next-line no-undef\n    this.createPreviewBlock(fileIndex);\n    // eslint-disable-next-line no-undef\n    await axios.post(route('dashboard.files.storeTempFile'), formData, {\n      onUploadProgress: (progressEvent) => {\n        const totalLength = progressEvent.lengthComputable ? progressEvent.total : progressEvent.target.getResponseHeader('content-length') || progressEvent.target.getResponseHeader('x-decompressed-content-length');\n        if (totalLength !== null) {\n          const progress = Math.round((progressEvent.loaded * 100) / totalLength);\n          this.progressBar(progress, fileIndex);\n        }\n      },\n    })\n      .then((resp) => {\n        resp = resp.data;\n        this.setPreviewValue(resp, fileIndex);\n        this.appendDeleteBtn(fileIndex);\n        this.createHiddenInputs(resp);\n      })\n      .catch((error) => {\n        this.errorHandler(error, fileIndex);\n        this.appendDeleteBtn(fileIndex, true);\n      });\n  }\n\n  setPreviewValue(fileInfo, fileIndex) {\n    const fileItem = $(this.$fileListEl)\n      .find(`.file__item[data-index=${fileIndex}]`);\n\n    fileItem.addClass(`file__item__type__${fileInfo.file_type}`);\n    fileItem.html(this.createHtmlForFile(fileInfo));\n  }\n\n  appendDeleteBtn(fileIndex, is_error = false) {\n    const fileItem = $(this.$fileListEl).find(`.file__item[data-index=${fileIndex}]`);\n    const view = ` <button class=\"position-absolute __delete__file __delete__file__btn\"\n                    data-index=\"${fileIndex}\"\n                    data-event-name=\"deleteFileItemEvent\"\n                    type=\"button\"><i class=\"fas fa-times\"></i></button>\n                    `;\n    fileItem.append(view);\n  }\n\n  createHiddenInputs(file) {\n    let arraySymbol = '';\n\n    if (this.is_multiple) {\n      arraySymbol = '[]';\n    }\n\n    this.$fileHiddenInputsBox.append(`<input type=\"hidden\" name=\"${this.inputName}${arraySymbol}\" value=\"${file.name}\">`);\n  }\n\n  errorHandler(error, fileIndex) {\n    const fileItem = $(this.$fileListEl).find(`.file__item[data-index=${fileIndex}]`);\n    fileItem.find('.progress-bar').addClass('bg-danger');\n\n    if (error.response && error.response.data.errors) {\n      this.$fileErrorBox.show();\n      error = error.response.data;\n      // eslint-disable-next-line no-restricted-syntax\n      for (const value of Object.entries(error.errors)) {\n        this.$fileErrorBox.find('ul').append(`<li data-index=\"${fileIndex}\">File :${fileIndex} ${value}</li>`);\n      }\n    }\n  }\n\n  progressBar(progress, fileIndex) {\n    $(this.$fileListEl)\n      .find(`.file__item[data-index=${fileIndex}] .file__progress .progress-bar`)\n      .css({ width: `${progress}%` })\n      .attr('aria-valuenow', progress)\n      .html(`${progress}%`);\n  }\n\n  createPreviewBlock(fileIndex) {\n    const preview = `\n            <div class=\"file__item d-flex justify-content-center position-relative mt-2\" data-index=\"${fileIndex}\">\n                <div class=\"progress file__progress \">\n                    <div class=\"progress-bar\"\n                         role=\"progressbar\"\n                         style=\"width: 0%;\"\n                         aria-valuenow=\"0\"\n                         aria-valuemin=\"0\"\n                         aria-valuemax=\"100\">\n                        0%\n                    </div>\n                </div>\n            </div>\n    `;\n\n    this.$fileListEl.append(preview);\n  }\n\n  // eslint-disable-next-line class-methods-use-this\n  createHtmlForFile(fileInfo) {\n    switch (fileInfo.file_type) {\n      case 'image':\n        return `<img src=\"${fileInfo.file_url}\" alt=\"${fileInfo.original_name}\" class=\"upload-file-img\">`;\n      default:\n        return `<span class=\"mr-5 text-primary p-2\">${fileInfo.original_name}</span>`;\n    }\n  }\n\n  // Delete functions start\n  deleteFileHandler(event) {\n    const el = event.target;\n    const index = $(el).data('index');\n\n    this.$fileErrorBox.find(`ul li[data-index=\"${index}\"]`).remove();\n    if (!this.$fileErrorBox.find('ul li').length) {\n      this.$fileErrorBox.hide();\n    }\n\n    $(el).closest('.file__item').remove();\n    this.$fileHiddenInputsBox.html('');\n    this.deleteFileEvent();\n  }\n\n  deleteFileEvent() {\n    window.addEventListener('deleteFileItemInDbEvent', (event) => {\n      const el = event.detail.element;\n      const boxLength = $(el).parents('.__uploaded__files').find('.file__item').length;\n      if (boxLength < 2) {\n        $(el).parents('.__uploaded__files').remove();\n      }\n      $(el).parents('.file__item').remove();\n    });\n  }\n  // Delete functions end\n}\n\n// eslint-disable-next-line no-new\nnew FileUploader();\n"],"names":["cropperModal","Modal","FileUploader","qualifiedDataName","reader","e","resp","formData","configKey","key","file","fileIndex","progressEvent","totalLength","progress","error","fileInfo","fileItem","is_error","view","arraySymbol","value","preview","event","el","index"],"mappings":"2HAIA,MAAMA,EAAe,IAAIC,EAAM,gBAAgB,EAE/C,MAAMC,CAAa,CACjB,aAAc,CACZ,KAAK,KAAM,CACf,CAEE,MAAO,CACL,KAAK,gBAAiB,EACtB,KAAK,YAAa,CACtB,CAEE,aAAc,CACZ,EAAE,MAAM,EAAE,GAAG,QAAS,uBAAwB,KAAK,kBAAkB,KAAK,IAAI,CAAC,EAC/E,EAAE,iCAAiC,EAAE,OAAO,KAAK,iBAAiB,KAAK,IAAI,CAAC,CAChF,CAEE,aAAaC,EAAmB,CAC9B,OAAO,KAAK,IAAI,aAAa,QAAQ,OAAAA,EAAmB,CAC5D,CAEE,kBAAmB,CACjB,KAAK,IAAM,MAAM,OACjB,KAAK,YAAc,EAAE,KAAK,GAAG,EAAE,SAAS,2BAA2B,EACnE,KAAK,cAAgB,EAAE,KAAK,GAAG,EAAE,SAAS,0BAA0B,EACpE,KAAK,qBAAuB,EAAE,KAAK,GAAG,EAAE,SAAS,qBAAqB,EACtE,KAAK,cAAe,EACpB,KAAK,SAAW,KAAK,IAAI,MACzB,KAAK,SAAW,GAEZ,EAAE,KAAK,GAAG,EAAE,KAAK,UAAU,GACzB,OAAO,KAAK,cAAiB,MAC/B,KAAK,YAAa,EAClB,KAAK,iBAAkB,GAGzB,KAAK,mBAAoB,IAEzB,KAAK,uBAAwB,EAC7B,KAAK,yBAA0B,GAGjC,KAAK,IAAI,MAAQ,EACrB,CAEE,wBAAyB,CACvB,KAAK,YAAc,KAAK,IAAI,aAAa,UAAU,IAAM,KAEpD,KAAK,aACR,EAAE,KAAK,GAAG,EAAE,SAAS,oBAAoB,EAAE,OAAQ,CAEzD,CAEE,aAAc,CACZ,KAAK,cAAgB,EAAE,qBAAqB,EAAE,QAAQ,CACpD,WAAY,GACZ,SAAU,CACR,MAAO,IACP,OAAQ,IACR,KAAM,QACP,EACD,SAAU,CACR,MAAO,IACP,OAAQ,GACT,CACP,CAAK,CACL,CAEE,oBAAqB,CACnBH,EAAa,KAAM,EAEnB,MAAMI,EAAS,IAAI,WACnBA,EAAO,OAAUC,GAAM,CACrB,KAAK,cAAc,QAAQ,OAAQ,CACjC,IAAKA,EAAE,OAAO,MACtB,CAAO,CACF,EACDD,EAAO,cAAc,KAAK,SAAS,CAAC,CAAC,EACrC,KAAK,SAAW,KAAK,SAAS,CAAC,EAAE,IACrC,CAEE,kBAAmB,CACjBJ,EAAa,KAAK,IAAM,CACtB,KAAK,cAAc,QAAQ,SAAU,CACnC,KAAM,SACN,KAAM,UACd,CAAO,EAAE,KAAMM,GAAS,CAEhB,KAAK,uBAAwB,EAE7B,MAAMC,EAAW,IAAI,SACrBA,EAAS,OAAO,aAAc,GAAG,YAAK,aAAa,YAAY,EAAC,KAAI,YAAK,aAAa,MAAM,EAAG,EAC/FA,EAAS,OAAO,OAAQD,CAAI,EAC5BC,EAAS,OAAO,OAAQ,KAAK,QAAQ,EACrC,KAAK,SAASA,EAAU,CAAC,EACzB,KAAK,UAAY,KAAK,aAAa,MAAM,EAEzCP,EAAa,KAAM,CAC3B,CAAO,CACP,CAAK,CACL,CAEE,eAAgB,CACd,KAAK,YAAY,KAAK,EAAE,EACxB,KAAK,cAAc,KAAK,IAAI,EAAE,KAAK,EAAE,EACrC,KAAK,cAAc,KAAM,EACzB,KAAK,qBAAqB,KAAK,EAAE,CACrC,CAEE,0BAA2B,CACzB,GAAI,KAAK,SAAU,CACjB,KAAK,UAAY,KAAK,aAAa,MAAM,EACzC,MAAMQ,EAAY,KAAK,aAAa,YAAY,EAEhD,SAAW,CAACC,EAAKC,CAAI,IAAK,OAAO,QAAQ,KAAK,QAAQ,EAAG,CACvD,MAAMH,EAAW,IAAI,SACrBA,EAAS,OAAO,aAAc,GAAG,OAAAC,EAAS,KAAI,YAAK,UAAW,EAC9DD,EAAS,OAAO,OAAQG,CAAI,EAC5B,KAAK,SAASH,EAAUE,CAAG,CACnC,CACA,CACA,CAEE,MAAM,SAASF,EAAUI,EAAW,CAElC,KAAK,mBAAmBA,CAAS,EAEjC,MAAM,MAAM,KAAK,MAAM,+BAA+B,EAAGJ,EAAU,CACjE,iBAAmBK,GAAkB,CACnC,MAAMC,EAAcD,EAAc,iBAAmBA,EAAc,MAAQA,EAAc,OAAO,kBAAkB,gBAAgB,GAAKA,EAAc,OAAO,kBAAkB,+BAA+B,EAC7M,GAAIC,IAAgB,KAAM,CACxB,MAAMC,EAAW,KAAK,MAAOF,EAAc,OAAS,IAAOC,CAAW,EACtE,KAAK,YAAYC,EAAUH,CAAS,CAC9C,CACO,CACF,CAAA,EACE,KAAML,GAAS,CACdA,EAAOA,EAAK,KACZ,KAAK,gBAAgBA,EAAMK,CAAS,EACpC,KAAK,gBAAgBA,CAAS,EAC9B,KAAK,mBAAmBL,CAAI,CAC7B,CAAA,EACA,MAAOS,GAAU,CAChB,KAAK,aAAaA,EAAOJ,CAAS,EAClC,KAAK,gBAAgBA,EAAW,EAAI,CAC5C,CAAO,CACP,CAEE,gBAAgBK,EAAUL,EAAW,CACnC,MAAMM,EAAW,EAAE,KAAK,WAAW,EAChC,KAAK,0BAA0B,OAAAN,EAAS,IAAG,EAE9CM,EAAS,SAAS,qBAAqB,OAAAD,EAAS,UAAW,EAC3DC,EAAS,KAAK,KAAK,kBAAkBD,CAAQ,CAAC,CAClD,CAEE,gBAAgBL,EAAWO,EAAW,GAAO,CAC3C,MAAMD,EAAW,EAAE,KAAK,WAAW,EAAE,KAAK,0BAA0B,OAAAN,EAAS,IAAG,EAC1EQ,EAAO,0GACiB,OAAAR,EAAS,+JAIvCM,EAAS,OAAOE,CAAI,CACxB,CAEE,mBAAmBT,EAAM,CACvB,IAAIU,EAAc,GAEd,KAAK,cACPA,EAAc,MAGhB,KAAK,qBAAqB,OAAO,8BAA8B,YAAK,WAAY,OAAAA,EAAW,aAAY,OAAAV,EAAK,KAAI,KAAI,CACxH,CAEE,aAAaK,EAAOJ,EAAW,CAI7B,GAHiB,EAAE,KAAK,WAAW,EAAE,KAAK,0BAA0B,OAAAA,EAAS,IAAG,EACvE,KAAK,eAAe,EAAE,SAAS,WAAW,EAE/CI,EAAM,UAAYA,EAAM,SAAS,KAAK,OAAQ,CAChD,KAAK,cAAc,KAAM,EACzBA,EAAQA,EAAM,SAAS,KAEvB,UAAWM,KAAS,OAAO,QAAQN,EAAM,MAAM,EAC7C,KAAK,cAAc,KAAK,IAAI,EAAE,OAAO,mBAAmB,OAAAJ,EAAS,YAAW,OAAAA,EAAS,KAAI,OAAAU,EAAK,QAAO,CAE7G,CACA,CAEE,YAAYP,EAAUH,EAAW,CAC/B,EAAE,KAAK,WAAW,EACf,KAAK,0BAA0B,OAAAA,EAAS,kCAAiC,EACzE,IAAI,CAAE,MAAO,GAAG,OAAAG,EAAQ,IAAK,CAAA,EAC7B,KAAK,gBAAiBA,CAAQ,EAC9B,KAAK,GAAG,OAAAA,EAAQ,IAAG,CAC1B,CAEE,mBAAmBH,EAAW,CAC5B,MAAMW,EAAU,0GACmF,OAAAX,EAAS,wbAc5G,KAAK,YAAY,OAAOW,CAAO,CACnC,CAGE,kBAAkBN,EAAU,CAC1B,OAAQA,EAAS,UAAS,CACxB,IAAK,QACH,MAAO,aAAa,OAAAA,EAAS,SAAQ,WAAU,OAAAA,EAAS,cAAa,8BACvE,QACE,MAAO,uCAAuC,OAAAA,EAAS,cAAa,UAC5E,CACA,CAGE,kBAAkBO,EAAO,CACvB,MAAMC,EAAKD,EAAM,OACXE,EAAQ,EAAED,CAAE,EAAE,KAAK,OAAO,EAEhC,KAAK,cAAc,KAAK,qBAAqB,OAAAC,EAAK,KAAI,EAAE,OAAQ,EAC3D,KAAK,cAAc,KAAK,OAAO,EAAE,QACpC,KAAK,cAAc,KAAM,EAG3B,EAAED,CAAE,EAAE,QAAQ,aAAa,EAAE,OAAQ,EACrC,KAAK,qBAAqB,KAAK,EAAE,EACjC,KAAK,gBAAiB,CAC1B,CAEE,iBAAkB,CAChB,OAAO,iBAAiB,0BAA4BD,GAAU,CAC5D,MAAMC,EAAKD,EAAM,OAAO,QACN,EAAEC,CAAE,EAAE,QAAQ,oBAAoB,EAAE,KAAK,aAAa,EAAE,OAC1D,GACd,EAAEA,CAAE,EAAE,QAAQ,oBAAoB,EAAE,OAAQ,EAE9C,EAAEA,CAAE,EAAE,QAAQ,aAAa,EAAE,OAAQ,CAC3C,CAAK,CACL,CAEA,CAGA,IAAItB"}